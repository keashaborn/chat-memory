services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: sage
      POSTGRES_PASSWORD: strongpassword
      POSTGRES_DB: memory
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sage -d memory"]
      interval: 2s
      timeout: 3s
      retries: 30

  brains:
    build:
      context: .
      dockerfile: Dockerfile.ci
    environment:
      POSTGRES_DSN: postgresql://sage:strongpassword@postgres:5432/memory
      ENABLE_VANTAGE_ENDPOINTS: "1"
      VANTAGE_TEST_MODE: "1"
      # keep these off; CI canary doesn't need them
      VANTAGE_PERSONAL_MEMORY: "0"
      VANTAGE_DEBUG: "0"
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8088:8088"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:8088/healthz >/dev/null"]
      interval: 2s
      timeout: 3s
      retries: 30
